name: LJF Cloud Network Setup
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - ljfcloud-server-add
    paths:
      - '.github/workflows/ljf-oci-nw.yml'    
jobs:
  Update_Security_Lists:
    runs-on: ubuntu-latest
    env:
      OCI_CLI_USER: ${{ vars.OCID_NETWORK_UPDATER_SA_USER }}
      OCI_CLI_TENANCY: ${{ vars.OCID_TENANT }}
      OCI_CLI_FINGERPRINT: ${{ vars.OCID_NETWORK_UPDATER_SA_FINGERPRINT }}
      OCI_CLI_KEY_CONTENT: ${{ secrets.NETWORKUPDATERSA_API_KEY }}
      OCI_CLI_REGION: 'uk-london-1'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Resolve IP address
        id: resolve_ip
        run: |
          IP=$(dig +short 14monarch.tplinkdns.com | tail -n1)
          echo "Resolved IP: $IP"
          echo "ip_address=$IP" >> $GITHUB_OUTPUT
      
      - name: Install OCI CLI
        run: |
          pip install oci-cli
      
      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.NETWORKUPDATERSA_API_KEY }}" > ~/.oci/key.pem
          chmod 600 ~/.oci/key.pem
          
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ vars.OCID_NETWORK_UPDATER_SA_USER }}
          fingerprint=${{ vars.OCID_NETWORK_UPDATER_SA_FINGERPRINT }}
          tenancy=${{ vars.OCID_TENANT }}
          region=${{ env.OCI_CLI_REGION }}
          key_file=~/.oci/key.pem
          EOF

      - name: Debug - List all security lists
        run: |
          # List all compartments you have access to
          echo "=== Compartments ==="
          oci iam compartment list --all
    
          # Try to list security lists in root compartment
          echo "=== Security Lists in Root ==="
          oci network security-list list --compartment-id ${{ vars.OCID_TENANT }} || true
    
          # If you know the VCN OCID, try that
          echo "=== Looking for your security list ==="
          oci search resource structured-search \
          --query-text "query securitylist resources where identifier = 'ocid1.securitylist.oc1.uk-london-1.aaaaaaaab4nhuwqnev7mwmlthoenkcn4ibi2xgtl3nkgqysie4c63jywo63q'" || true

      
      - name: Update Security List
        run: |
          SECURITY_LIST_ID="${{ vars.OCID_SECURITY_LIST }}"
          IP="${{ steps.resolve_ip.outputs.ip_address }}"
          
          # Get current security list
          oci network security-list get --security-list-id $SECURITY_LIST_ID --debug > current_rules.json
          
          # Extract existing ingress rules
          EXISTING_RULES=$(cat current_rules.json | jq '.data."ingress-security-rules"')
          
          # Create new rule
          NEW_RULE=$(cat << EOF
          {
            "protocol": "6",
            "source": "${IP}/32",
            "tcpOptions": {
              "destinationPortRange": {
                "min": 9001,
                "max": 9001
              }
            },
            "description": "Allow port 9001 from 14monarch.tplinkdns.com"
          }
          EOF
          )
          
          # Combine existing rules with new rule
          COMBINED_RULES=$(echo $EXISTING_RULES | jq ". + [$NEW_RULE]")
          
          # Update security list
          oci network security-list update \
            --security-list-id $SECURITY_LIST_ID \
            --ingress-security-rules "$COMBINED_RULES" \
            --force
          
          echo "Security list updated successfully for IP: $IP"
