name: Redeploy Nextloud via Portainer GitOps

on:
  push:
    branches:
      - main
    paths:
      - 'nextcloud-compose.yml'
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Install WireGuard
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard resolvconf
      - name: Install systemd-resolved
        run: |
          sudo apt-get update
          sudo apt-get install -y systemd-resolved
          sudo systemctl start systemd-resolved
          sudo systemctl enable systemd-resolved
      - name: Write WireGuard config
        run: |
          echo "${{ secrets.WG_CONFIG }}" > wg0.conf
      - name: Bring up VPN
        run: |
          sudo wg-quick up ./wg0.conf
          sudo wg show
      - name: Configure split DNS
        run: |
          sudo resolvectl dns wg0 192.168.0.2   # your Pi-hole IP
          sudo resolvectl domain wg0 '~local'   # only .local via wg0
      - name: Call Portainer webhook
        run: |
          curl -X POST \
            http://portainer.14monarch.local/api/stacks/webhooks/ee38b35e-35c4-4091-92b9-679a3e6cfc77
      - name: Rescan files in external drive
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: liam-pi4
          username: ${{ secrets.PI_USER }}
          password: ${{ secrets.PI_PASSWORD }}
          script: |
            docker exec -u www-data nextcloud php occ files:scan --all
