name: Wireguard Test
on:
  push:
    branches:
      - "*"
  workflow_dispatch:
jobs:
  Wireguard_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Install WireGuard
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard resolvconf dnsutils
      - name: Write WireGuard config
        run: |
          echo "${{ secrets.WG_CONFIG }}" > wg0.conf
#      - name: Resolve DDNS and update wg0.conf
#        run: |
#          ip=$(dig +short 14monarch.tplinkdns.com @8.8.8.8 | tail -n1)
#          if [ -z "$ip" ]; then
#          echo "‚ùå Failed to resolve 14monarch.tplinkdns.com"
#          exit 1
#          fi
#          echo "‚úÖ Resolved 14monarch.tplinkdns.com to $ip"
#          sudo sed -i "s|14monarch.tplinkdns.com|$ip|" wg0.conf
#          echo "üîß Updated wg0.conf to use $ip instead of DDNS"
      - name: Bring up VPN
        run: |
          sudo wg-quick up ./wg0.conf
          sudo wg show
 
      - name: Check resolv.conf symlink
        run: ls -l /etc/resolv.conf
  
      - name: Force DNS to Cloudflare
        run: |
          echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
          sudo systemctl restart systemd-resolved || true

      - name: Override system DNS resolver
        run: |
          sudo rm /etc/resolv.conf
          echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf

      - name: Check WireGuard interface
        run: |
          ip addr show wg0
          ip link show wg0
  
      - name: Check routing table
        run: ip route
  
      - name: Ping VPN peer
        run: ping -c 4 192.168.0.1
        continue-on-error: true
  
      - name: Test DNS resolution
        run: nslookup github.com
        continue-on-error: true
  
      - name: Force DNS to Cloudflare (fallback)
        if: failure()
        run: echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
  
      - name: Test external connectivity
        run: curl -I https://github.com
        continue-on-error: true
  
      - name: SSH into VPN peer
        run: |
          sshpass -p "${{ secrets.PI_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ vars.PI_USER }}@${{ vars.PI_HOST_IP }} "hostname && uptime"
        continue-on-error: true
        
      - name: Bring down VPN
        run: |
          sudo wg-quick down ./wg0.conf
          sudo wg show   
